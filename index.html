<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Game of Boat</title>
	</head>
	<body>
        <!-- Style Menu! -->
        <link rel="stylesheet" type="text/css" href="css/menu.css"/> 
        
        <!-- Three.js! -->
		<script src="js/three.js"></script>
        
        <!-- Leitores de objetos 3D! -->
		<script src="js/OBJLoader.js"></script>
        <script src="js/MTLLoader.js"></script>
        <script src="js/DDSLoader.js"></script>
        <script src="js/FBXLoader.js"></script>
        <script src="js/inflate.min.js"></script>
        
        <!-- JQuery! -->
        <script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
        
        <!-- Skybox e Oceano! -->
        <script src="js/Water.js"></script>
		<script src="js/Sky.js"></script>
        
		<!-- Vertex Shader Compass! -->
		<script type="x-shader/x-vertex" id="vertexShaderCompass">
			void main(){
				gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.0);
			}
		</script>
        
        <!-- Fragment Shader Compass! -->
		<script type="x-shader/x-fragment" id="fragmentShaderCompass">
			void main(){
				gl_FragColor = vec4(0, 0, 0, 1.0);
			}
		</script>
        
        <!-- Vertex Shader Dragon! -->
		<script type="x-shader/x-vertex" id="vertexShaderDragon">
            uniform mat4 scale;
            uniform mat4 translation;

            void main() {
                vec4 mvPosition = viewMatrix * translation * scale * vec4(position, 1.0);
				gl_Position = projectionMatrix * mvPosition;
            }
		</script>
        
        <!-- Fragment Shader Dragon! -->
		<script type="x-shader/x-fragment" id="fragmentShaderDragon">
			void main(){
				gl_FragColor = vec4(0, 0, 0, 1.0);
			}
		</script>
        
        <div id="panel">
            <div class="menu">
                <h1>Bem vindo ao Game of Boat!</h1>
                <h3>
                    Objetivo do jogo: Encoste o 10 vezes no outro barco em 1 minuto!<br>
                    Controles: A/W/S/D para movimentação.<br>
                    Cameras: 1,2,0<br>
                    O norte da bússola sempre aponta para o outro barco.<br>
                    Nunca chegue perto do vulção...
                </h3>
                <button type="button" id="initGame">Começar!</button>
            </div>
        </div>
        
        <div id="scoreboard">
            <div class="info">
                <div id="time">Tempo restante: 0:00</div><br>
                <div id="points">Pontuação: 0</div>
            </div>
        </div>
        
        <div id="lose"></div>
        <div id="win"></div>
        
		<script>
            //Inicia as animações!
            var paused = 0;
            
            //Seta valores para audio de fundo!
            //more information about audio: https://www.youtube.com/watch?v=gNUm_uNMLcc
            var song = document.createElement('audio');
            music(0);
            
            //Apaga o Menu e inicia o jogo!
            $('#initGame').click(function(){
                paused = 1;
                $('#panel').remove();
            });
            
            //Objetos!
			var boat1, boat2, compass, water, volcano, dragon, shrek;
            var compassx, compassy, compassz;
            
            //Curva!
            var curve_c = 0, curve_idx = 0, boat2_speed = 0.07;
            
            //Movimentação!
            var keyboard = {};
            var player = { height:1.8, speed:5, turnSpeed:Math.PI*0.02 , points:0};
            var setMove = false;
            keyboard[83] = false; keyboard[87] = false; keyboard[68] = false; keyboard[65] = false;
            
            //Criando renderizador e setando configurações de tela
            var renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);//Seta o tamanho da tela
			renderer.setPixelRatio(window.devicePixelRatio);//Evita borrões devido a proporção de pixels
			document.body.appendChild(renderer.domElement);//Adiciona na tela a cena
            
            //Adicionando luz ambiente e cor de fundo na cena!
			var scene = new THREE.Scene();
            scene.add(new THREE.AmbientLight(0xffffff));
            scene.background = new THREE.Color(0xf0f0f0);
            
			var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 5000);
            //Posicionando camera em terceira pessoa!
			camera.position.z = 200;
            camera.position.y = 170;
            camera.rotation.x = -20 * Math.PI / 180;
            compassx = -60;
            compassy = -70;
            compassz = -100;
		
            uniforms2 = {
				scale: {value: new THREE.Matrix4().set(150, 0, 0, 0,
                                                       0, 150, 0, 0,
                                                       0, 0, 150, 0,
                                                       0, 0, 0, 1)},
                
                translation: {value: new THREE.Matrix4().set(1, 0, 0, 100000,
                                                             0, 1, 0, -90,
                                                             0, 0, 1, 99499,
                                                             0, 0, 0, 1)}
            };
            
			/*Criando o material a partir do shader*/
			var materialCompass = new THREE.ShaderMaterial( {
				vertexShader: document.getElementById('vertexShaderCompass').textContent,
				fragmentShader: document.getElementById('fragmentShaderCompass').textContent,
			});
            
            var materialDragon = new THREE.ShaderMaterial( {
                uniforms: uniforms2,
				vertexShader: document.getElementById('vertexShaderDragon').textContent,
				fragmentShader: document.getElementById('fragmentShaderDragon').textContent,
			});		
            
            THREE.Loader.Handlers.add( /\.dds$/i, new THREE.DDSLoader());
            var mtlLoader = new THREE.MTLLoader();
            
            //Adicionando o Barco 1 na cena!
            mtlLoader.setPath( 'models/Going_Merry/' );
            mtlLoader.load( 'GoingMerry.mtl', function( materials ) {

                materials.preload();

                var objLoader = new THREE.OBJLoader();
                objLoader.setMaterials( materials );
                objLoader.setPath( 'models/Going_Merry/' );
                objLoader.load( 'GoingMerry.obj', function ( object ) {
                    
                    boat1 = object;
                    object.position.y = 6;
                    object.position.x = 0;
                    object.position.z = -25;
                    object.scale.x = 0.03;
                    object.scale.y = 0.03;
                    object.scale.z = 0.03;
                    object.rotation.y = 180 * Math.PI / 180;
                    scene.add( object );

                });

            });
            
            
            //Adicionando o Barco 2 na cena!
            var mtlLoader2 = new THREE.MTLLoader();
            mtlLoader2.setPath('models/Thousand_Sunny/');
            mtlLoader2.load('sunny.mtl', function(materials) {
                materials.preload();

                var objLoader = new THREE.OBJLoader();
                objLoader.setMaterials( materials );
                objLoader.setPath( 'models/Thousand_Sunny/' );
                objLoader.load( 'sunny.obj', function ( object ) {
                    
                    boat2 = object;
                    object.position.y = 10;
                    object.position.x = -100;
                    object.position.z = -300;
                    object.scale.x = 0.0125;
                    object.scale.y = 0.0125;
                    object.scale.z = 0.0125;
                    object.rotation.y = 180 * Math.PI / 180;
                    scene.add( object );

                });

            });
            
            var texture = new THREE.TextureLoader().load( "texture/volcano.jpg" );
            texture.wrapS = THREE.RepeatWrapping;
            texture.wrapT = THREE.RepeatWrapping;
            texture.repeat.set( 8, 8 );
            
            var phong = new THREE.MeshPhongMaterial( { specular: 0x111111, map: texture } );
            //Adicionando Volcano na cena!
            var loader = new THREE.OBJLoader();
			loader.load('models/Volcano/volcano.obj', function(object){//Carregando o objeto
			
				object.traverse(function (child) {
					if ( child instanceof THREE.Mesh) {
						child.material = phong;//aplica o material em cada vertice do objeto
					}
				} );
				
				volcano = object;
                
                object.position.x = 300;
                object.position.y = 0;
                object.position.z = -600;
                
                object.scale.x = 500;
                object.scale.y = 500;
                object.scale.z = 500;
                scene.add(object);//Adiciona o objeto
			});
            
            //Adicionando Dragon na cena!
            var loader = new THREE.OBJLoader();
			loader.load('models/Dragon/Dargon_posing.obj', function(object){//Carregando o objeto
			
				object.traverse(function (child) {
					if ( child instanceof THREE.Mesh) {
						child.material = materialDragon;//aplica o material em cada vertice do objeto
					}
				} );
				
                dragon = object;				
                scene.add(object);//Adiciona o objeto
		});
